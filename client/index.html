<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>Pickleball Trade</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1200px;margin:0 auto}
.header{text-align:center;color:white;margin-bottom:30px}
.card{background:white;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;margin-bottom:8px}
.form-group input,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px}
.btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.btn-success{background:#25D366;color:white}
.btn-email{background:linear-gradient(135deg,#4285f4,#34a853);color:white}
.btn-warning{background:#ffc107;color:#333}
.btn-orange{background:linear-gradient(135deg,#f39c12,#e74c3c);color:white}
.btn-cyan{background:linear-gradient(135deg,#17a2b8,#20c997);color:white}
.btn-disabled{background:#ccc;cursor:not-allowed}
.btn-disabled:hover{transform:none;box-shadow:none}
.btn-sent{background:linear-gradient(135deg,#28a745,#20c997);color:white;position:relative}
.btn-sent::after{content:'âœ“';position:absolute;top:-5px;right:-5px;background:#fff;color:#28a745;border-radius:50%;width:18px;height:18px;font-size:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.btn-sm{padding:8px 16px;font-size:13px}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:20px}
.stat{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center}
.stat.success{background:linear-gradient(135deg,#28a745,#20c997)}
.stat.info{background:linear-gradient(135deg,#17a2b8,#3498db)}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto}
.toast{position:fixed;bottom:20px;right:20px;padding:16px 24px;border-radius:8px;display:none;z-index:2000}
.toast.show{display:block}
.toast.success{background:#28a745;color:white}
.toast.error{background:#dc3545;color:white}
.toast.info{background:#17a2b8;color:white}
.toast.warning{background:#ffc107;color:#333}
.email-status{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-size:14px}
.email-status.configured{background:#d4edda;color:#155724}
.email-status.not-configured{background:#f8d7da;color:#721c24}
.send-status{font-size:12px;color:#666;margin-top:8px}
.loading{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.attachment-list{background:#f8f9fa;border-radius:8px;padding:12px;margin-top:12px}
.attachment-item{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid #eee}
.attachment-item:last-child{border-bottom:none}
.attachment-icon{font-size:20px}
.attachment-name{flex:1;font-size:13px;word-break:break-all}
.attachment-size{font-size:11px;color:#666;white-space:nowrap}
.attachment-warning{color:#dc3545;font-size:11px}
.checkbox-group{display:flex;align-items:center;gap:8px;margin:12px 0}
.checkbox-group input[type="checkbox"]{width:18px;height:18px}
.sent-badge{display:inline-flex;align-items:center;gap:4px;background:#d4edda;color:#155724;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:8px}
.source-badge{display:inline-flex;align-items:center;gap:4px;background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:12px;font-size:10px}
.enriched-badge{background:#fff3cd;color:#856404;padding:2px 8px;border-radius:12px;font-size:10px}
.action-buttons{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.permission-modal{background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:16px;margin:16px 0}
.permission-modal h4{color:#856404;margin-bottom:12px}
.permission-modal ol{margin-left:20px;color:#856404}
.permission-modal li{margin-bottom:8px}
.strategy-select{font-size:13px;padding:8px}
.strategy-desc{font-size:11px;color:#666;margin-top:4px}
.curated-card{border:2px solid #ffc107;background:linear-gradient(135deg,#fffbeb,#fff)}
.curated-card h2{color:#856404}
.company-list{max-height:300px;overflow-y:auto;background:#f8f9fa;border-radius:8px;padding:12px;margin-top:12px}
.company-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee}
.company-item:last-child{border-bottom:none}
.company-name{font-weight:600}
.company-meta{font-size:12px;color:#666}
.scrape-form{background:#f8f9fa;padding:16px;border-radius:8px;margin-top:12px}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ“ Pickleball Trade</h1>
<p>Outreach Dashboard - Multi-Source Lead Discovery</p>
<div id="emailStatus" class="email-status not-configured" style="margin-top:12px">
Checking email status...
</div>
</div>

<!-- CURATED COMPANIES CARD -->
<div class="card curated-card"><h2>ğŸŒŸ Curated Pickleball Companies</h2>
<p style="color:#666;margin-bottom:16px">Known importers, distributors, JOOLA dealers - verified companies with direct website scraping</p>
<div class="grid">
<div>
<button class="btn btn-orange" onclick="discoverCurated()">ğŸŒŸ Import Curated List</button>
<button class="btn btn-cyan" style="margin-left:8px" onclick="viewCurated()">ğŸ‘ï¸ View Companies</button>
<div id="curatedStatus" class="send-status" style="margin-top:8px"></div>
</div>
<div>
<div class="scrape-form">
<label style="font-weight:600;margin-bottom:8px;display:block">ğŸ”— Scrape Any Website</label>
<div style="display:flex;gap:8px">
<input type="text" id="scrapeUrl" placeholder="https://example.com" style="flex:1;padding:8px;border:2px solid #e0e0e0;border-radius:8px">
<button class="btn btn-primary btn-sm" onclick="scrapeWebsite()">ğŸ•¸ï¸ Scrape</button>
</div>
<div id="scrapeResult" class="send-status" style="margin-top:8px"></div>
</div>
</div>
</div>
</div>

<!-- DISCOVER LEADS CARD -->
<div class="card"><h2>ğŸ” Discover Leads</h2>
<p style="color:#666;margin-bottom:16px">Find distributors, wholesalers, and dealers across multiple sources</p>
<div class="grid-3">
<div class="form-group">
<label>City</label>
<select id="city"><option value="">Select City</option></select>
</div>
<div class="form-group">
<label>Limit</label>
<input type="number" id="limit" value="10" min="5" max="50">
</div>
<div class="form-group">
<label>Search Strategy</label>
<select id="strategy" class="strategy-select">
<option value="">ğŸ¯ Auto (Recommended)</option>
<option value="curated">ğŸŒŸ Curated Companies (Best)</option>
<option value="directories">ğŸ“ Industry Directories (IndiaMART, TradeIndia, JustDial)</option>
<option value="manufacturers">ğŸ­ Manufacturer Distributor Lists</option>
<option value="google">ğŸ” Google Advanced Search</option>
<option value="linkedin">ğŸ’¼ LinkedIn Profiles</option>
<option value="yellowpages">ğŸ“’ Yellow Pages & Chambers</option>
<option value="marketplaces">ğŸ›’ Marketplace Sellers</option>
<option value="sports_shops">ğŸ¸ Related Sports Shops</option>
</select>
</div>
</div>
<div class="checkbox-group">
<input type="checkbox" id="deepSearch">
<label for="deepSearch" style="margin:0;font-weight:normal">ğŸš€ Deep Search - Use ALL strategies (slower but finds more leads)</label>
</div>
<div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
<button class="btn btn-primary" onclick="discover()">ğŸ” Discover Leads</button>
<button class="btn btn-warning" onclick="discoverAll()">ğŸŒ Discover All Cities</button>
<button class="btn btn-cyan" onclick="enrichAll()">ğŸ”— Enrich All Leads</button>
</div>
<div id="discoverStatus" class="send-status" style="margin-top:12px"></div>
</div>

<!-- EMAIL & WHATSAPP CONFIG -->
<div class="card"><h2>ğŸ“§ Email & WhatsApp Configuration</h2>
<div class="grid">
<div>
<h4 style="margin-bottom:12px">Gmail Status</h4>
<div class="form-group"><label>Email</label><input type="text" id="gmailEmail" placeholder="Configured on server" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Status</label><input type="text" id="gmailStatus" placeholder="Checking..." readonly style="background:#f8f9fa"></div>
</div>
<div>
<h4 style="margin-bottom:12px">ğŸ“ Attachments</h4>
<div id="attachmentsList" class="attachment-list">
<p style="color:#666;text-align:center">Loading...</p>
</div>
</div>
</div>
<button class="btn btn-primary" style="margin-top:16px" onclick="checkEmailStatus()">ğŸ”„ Refresh Status</button>
</div>

<!-- STATS -->
<div class="stats">
<div class="stat"><h3 id="total">0</h3><p>Total Leads</p></div>
<div class="stat info"><h3 id="withEmail">0</h3><p>With Email</p></div>
<div class="stat info"><h3 id="withPhone">0</h3><p>With Phone</p></div>
<div class="stat success"><h3 id="emails">0</h3><p>ğŸ“§ Sent</p></div>
<div class="stat success"><h3 id="whatsapps">0</h3><p>ğŸ’¬ Sent</p></div>
</div>

<!-- LEADS TABLE -->
<div class="card">
<div style="display:flex;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
<h2>ğŸ“‹ Leads</h2>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn btn-primary btn-sm" onclick="refresh()">ğŸ”„ Refresh</button>
<button class="btn btn-cyan btn-sm" onclick="enrichAll()">ğŸ”— Enrich Missing</button>
<button class="btn btn-primary btn-sm" onclick="exportCSV()">ğŸ“¥ Export CSV</button>
</div>
</div>
<table><thead><tr><th>Business</th><th>Type</th><th>Contact</th><th>Source</th><th>Status</th><th>Actions</th></tr></thead>
<tbody id="tbody"><tr><td colspan="6" style="text-align:center">Loading...</td></tr></tbody>
</table>
</div>
</div>

<!-- CURATED COMPANIES MODAL -->
<div class="modal" id="curatedModal">
<div class="modal-content">
<h2>ğŸŒŸ Known Pickleball Companies in India</h2>
<p style="color:#666;margin:12px 0">These are verified importers, distributors, and dealers. Click "Import All" to add them with contact scraping.</p>
<div id="curatedList" class="company-list">Loading...</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-orange" onclick="discoverCurated();closeCuratedModal()">ğŸŒŸ Import All with Scraping</button>
<button class="btn" onclick="closeCuratedModal()">Close</button>
</div>
</div>
</div>

<!-- PERMISSION MODAL -->
<div class="modal" id="permissionModal">
<div class="modal-content">
<h2>ğŸ” Accessibility Permission Required</h2>
<div class="permission-modal">
<h4>One-time setup to enable WhatsApp automation:</h4>
<ol id="permissionInstructions">
<li>Open <b>System Settings</b> on your Mac</li>
<li>Go to <b>Privacy & Security â†’ Accessibility</b></li>
<li>Click the lock icon to make changes</li>
<li>Add and enable <b>Terminal</b> (or VS Code)</li>
<li>Click "Done" below after granting permission</li>
</ol>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-success" onclick="confirmPermission()">âœ… Done - Permission Granted</button>
<button class="btn" onclick="closePermissionModal()">Cancel</button>
</div>
</div>
</div>

<!-- SEND MODAL -->
<div class="modal" id="modal">
<div class="modal-content">
<h2>ğŸ“¤ Send Proposal</h2>
<div id="alreadySentWarning" style="display:none;background:#fff3cd;color:#856404;padding:12px;border-radius:8px;margin-bottom:16px">
âš ï¸ Message already sent to this lead. Send again?
</div>
<div class="grid">
<div class="form-group"><label>Business</label><input id="recipient" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Type</label><input id="recipientType" readonly style="background:#f8f9fa"></div>
</div>
<div class="grid">
<div class="form-group"><label>Email</label><input id="recipientEmail" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Phone</label><input id="recipientPhone" readonly style="background:#f8f9fa"></div>
</div>
<div class="form-group"><label>Subject</label><input id="emailSubject" value="Pickleball Partnership Opportunity - Manh Thang Factory"></div>

<div class="checkbox-group">
<input type="checkbox" id="includeAttachments" checked>
<label for="includeAttachments" style="margin:0;font-weight:normal">ğŸ“ Include email attachments</label>
</div>
<div class="checkbox-group">
<input type="checkbox" id="includeWAImage" checked>
<label for="includeWAImage" style="margin:0;font-weight:normal">ğŸ–¼ï¸ Include product image in WhatsApp</label>
</div>

<div id="modalAttachments" class="attachment-list" style="margin-bottom:16px"></div>

<div class="form-group">
<label>Message Preview</label>
<div id="msgText" style="background:#f8f9fa;padding:16px;border-radius:8px;white-space:pre-wrap;max-height:150px;overflow-y:auto;font-size:12px"></div>
</div>
<div id="sendStatus" class="send-status"></div>
<div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
<button class="btn btn-email" id="sendEmailBtn" onclick="sendEmail()">ğŸ“§ Send Email</button>
<button class="btn btn-success" id="sendWABtn" onclick="sendWA()">ğŸ’¬ WhatsApp + Image</button>
<button class="btn btn-cyan" onclick="enrichCurrent()">ğŸ”— Enrich</button>
<button class="btn" onclick="closeModal()">Close</button>
</div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = "http://localhost:8000";
let entities = [], current = null, emailConfigured = false;
let availableAttachments = [];
let waPermissionGranted = false;
let pendingWAEntity = null;

const PROPOSAL_TEMPLATE = `Dear Sir / Madam,

Greetings from Manh Thang Pickleball Factory! ğŸ“

We are a leading manufacturer of tournament-grade pickleball equipment from Vietnam, looking for distribution partners in India.

âœ… Our Products:
â€¢ USAPA-certified pickleball balls
â€¢ Premium paddles & nets
â€¢ OEM/private label available

ğŸ­ Factory Capacity: 25,000-30,000 balls/day

ğŸ¤ Partnership Benefits:
â€¢ Factory-direct competitive pricing
â€¢ Bulk order discounts
â€¢ Reliable delivery schedules

ğŸ“ Contact:
Vijay Pawar (India)
WhatsApp: +91-7975397211
Email: vijaykp.kp@gmail.com

Looking forward to your response!

Best regards,
Vijay Pawar`;

document.addEventListener("DOMContentLoaded", () => {
    loadCities();
    refresh();
    checkEmailStatus();
    checkWAPermission();
});

function getFileIcon(filename) {
    if (filename.toLowerCase().endsWith('.pdf')) return 'ğŸ“„';
    if (filename.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/)) return 'ğŸ–¼ï¸';
    return 'ğŸ“';
}

function renderAttachments(containerId, attachments) {
    const container = document.getElementById(containerId);
    if (!attachments || attachments.length === 0) {
        container.innerHTML = '<p style="color:#666;text-align:center;font-size:13px">No attachments</p>';
        return;
    }
    container.innerHTML = attachments.map(a => `
        <div class="attachment-item">
            <span class="attachment-icon">${getFileIcon(a.name)}</span>
            <span class="attachment-name">${a.name}</span>
            <span class="attachment-size">${a.size_mb} MB</span>
            ${a.too_large ? '<span class="attachment-warning">âš ï¸ Too large</span>' : 'âœ…'}
        </div>
    `).join('');
}

async function checkEmailStatus() {
    try {
        const r = await fetch(API + "/email/status");
        const d = await r.json();
        emailConfigured = d.configured;
        availableAttachments = d.attachments || [];
        
        const statusEl = document.getElementById("emailStatus");
        if (d.configured) {
            statusEl.className = "email-status configured";
            statusEl.innerHTML = "âœ… Email: " + d.sender;
            document.getElementById("gmailStatus").value = "âœ“ Configured";
            document.getElementById("gmailEmail").value = d.sender;
        } else {
            statusEl.className = "email-status not-configured";
            statusEl.innerHTML = "âš ï¸ Email not configured";
            document.getElementById("gmailStatus").value = "âœ— Not configured";
            document.getElementById("gmailEmail").value = "Set .env file";
        }
        renderAttachments('attachmentsList', availableAttachments);
    } catch (e) {
        document.getElementById("emailStatus").innerHTML = "âŒ API not reachable";
    }
}

async function checkWAPermission() {
    try {
        const r = await fetch(API + "/whatsapp/status");
        const d = await r.json();
        waPermissionGranted = d.permission_granted;
    } catch (e) {}
}

async function loadCities() {
    try {
        const r = await fetch(API + "/cities");
        const d = await r.json();
        const s = document.getElementById("city");
        d.cities.forEach(c => {
            const o = document.createElement("option");
            o.value = c.name;
            o.textContent = `${c.name} (${c.tier})`;
            s.appendChild(o);
        });
    } catch (e) {}
}

// ============ CURATED COMPANIES ============

async function viewCurated() {
    document.getElementById("curatedModal").classList.add("active");
    document.getElementById("curatedList").innerHTML = '<p style="text-align:center"><span class="loading"></span> Loading...</p>';
    
    try {
        const r = await fetch(API + "/curated");
        const d = await r.json();
        
        document.getElementById("curatedList").innerHTML = d.companies.map(c => `
            <div class="company-item">
                <div>
                    <div class="company-name">${c.name}</div>
                    <div class="company-meta">${c.role} â€¢ ${c.city}</div>
                </div>
                <a href="${c.website}" target="_blank" style="color:#667eea;font-size:12px">ğŸ”— Visit</a>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById("curatedList").innerHTML = '<p style="color:#dc3545">Error loading companies</p>';
    }
}

function closeCuratedModal() { document.getElementById("curatedModal").classList.remove("active"); }

async function discoverCurated() {
    const statusEl = document.getElementById("curatedStatus");
    statusEl.innerHTML = '<span class="loading"></span> Importing curated companies with website scraping...';
    
    try {
        const r = await fetch(API + "/discover/curated", { method: "POST" });
        const d = await r.json();
        
        statusEl.innerHTML = `âœ… Imported ${d.discovered} companies, ${d.with_contacts} have contact info`;
        toast(`Imported ${d.discovered} curated companies!`, "success");
        refresh();
    } catch (e) {
        statusEl.innerHTML = 'âŒ Error importing companies';
        toast("Error importing companies", "error");
    }
}

async function scrapeWebsite() {
    const url = document.getElementById("scrapeUrl").value.trim();
    if (!url) { toast("Enter a URL", "error"); return; }
    
    const statusEl = document.getElementById("scrapeResult");
    statusEl.innerHTML = '<span class="loading"></span> Scraping website...';
    
    try {
        const r = await fetch(API + "/scrape", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url, follow_contact_pages: true })
        });
        const d = await r.json();
        
        if (d.email || d.phone) {
            statusEl.innerHTML = `âœ… Found: ${d.email || 'No email'} | ${d.phone || 'No phone'}`;
            toast("Contact info found!", "success");
        } else {
            statusEl.innerHTML = 'âš ï¸ No contact info found on this website';
            toast("No contact info found", "warning");
        }
    } catch (e) {
        statusEl.innerHTML = 'âŒ Error scraping website';
        toast("Scrape error", "error");
    }
}

// ============ ENRICHMENT ============

async function enrichAll() {
    const statusEl = document.getElementById("discoverStatus");
    statusEl.innerHTML = '<span class="loading"></span> Enriching leads by scraping their websites...';
    
    try {
        const r = await fetch(API + "/enrich", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ limit: 50 })
        });
        const d = await r.json();
        
        statusEl.innerHTML = `âœ… Enriched ${d.enriched}/${d.processed} leads with contact info`;
        toast(`Enriched ${d.enriched} leads!`, "success");
        refresh();
    } catch (e) {
        statusEl.innerHTML = 'âŒ Error enriching leads';
        toast("Enrichment error", "error");
    }
}

async function enrichCurrent() {
    if (!current) return;
    
    const statusEl = document.getElementById("sendStatus");
    statusEl.innerHTML = '<span class="loading"></span> Scraping website for contact info...';
    
    try {
        const r = await fetch(API + `/enrich/${current.id}`, { method: "POST" });
        const d = await r.json();
        
        statusEl.innerHTML = `âœ… Found: ${d.email || 'No email'} | ${d.phone || 'No phone'}`;
        
        // Update current entity
        if (d.email) current.email = d.email;
        if (d.phone) current.phone = d.phone;
        
        document.getElementById("recipientEmail").value = d.email || "No email";
        document.getElementById("recipientPhone").value = d.phone || "No phone";
        
        toast("Lead enriched!", "success");
        refresh();
    } catch (e) {
        statusEl.innerHTML = 'âŒ Error enriching lead';
        toast("Enrichment error", "error");
    }
}

// ============ DISCOVER ============

async function discover() {
    const city = document.getElementById("city").value;
    const limit = document.getElementById("limit").value;
    const strategy = document.getElementById("strategy").value;
    const deepSearch = document.getElementById("deepSearch").checked;
    
    if (!city) { toast("Select a city", "error"); return; }
    
    const statusEl = document.getElementById("discoverStatus");
    statusEl.innerHTML = '<span class="loading"></span> Discovering leads using ' + (deepSearch ? 'deep search (all strategies)' : strategy || 'auto strategy') + '...';
    
    try {
        const r = await fetch(API + "/discover", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ city, limit: parseInt(limit), strategy: strategy || null, deep_search: deepSearch })
        });
        const d = await r.json();
        statusEl.innerHTML = `âœ… Found ${d.discovered} leads from: ${d.sources?.join(', ') || 'web_search'}`;
        toast(`Found ${d.discovered} leads!`, "success");
        refresh();
    } catch (e) {
        statusEl.innerHTML = 'âŒ Error discovering leads';
        toast("Error discovering leads", "error");
    }
}

async function discoverAll() {
    if (!confirm("This will search ALL cities. It may take a while. Continue?")) return;
    
    const statusEl = document.getElementById("discoverStatus");
    const cities = [...document.getElementById("city").options].slice(1).map(o => o.value);
    
    statusEl.innerHTML = `<span class="loading"></span> Searching ${cities.length} cities...`;
    
    let total = 0;
    for (const city of cities) {
        try {
            const r = await fetch(API + "/discover", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ city, limit: 5 })
            });
            const d = await r.json();
            total += d.discovered;
            statusEl.innerHTML = `<span class="loading"></span> ${city}: Found ${d.discovered} | Total: ${total}`;
        } catch (e) {}
    }
    
    statusEl.innerHTML = `âœ… Complete! Found ${total} leads across ${cities.length} cities`;
    refresh();
}

// ============ REFRESH & RENDER ============

async function refresh() {
    try {
        const r = await fetch(API + "/entities");
        const d = await r.json();
        entities = d.entities || [];
        render();
        
        const s = await (await fetch(API + "/stats")).json();
        document.getElementById("total").textContent = s.total_entities || 0;
        document.getElementById("withEmail").textContent = s.with_email || 0;
        document.getElementById("withPhone").textContent = s.with_phone || 0;
        document.getElementById("emails").textContent = s.emails_sent || 0;
        document.getElementById("whatsapps").textContent = s.whatsapp_sent || 0;
    } catch (e) {
        document.getElementById("tbody").innerHTML = '<tr><td colspan="6">API not running</td></tr>';
    }
}

function render() {
    const t = document.getElementById("tbody");
    if (entities.length === 0) {
        t.innerHTML = '<tr><td colspan="6" style="text-align:center">No leads yet. Discover some!</td></tr>';
        return;
    }
    t.innerHTML = entities.map(e => {
        const emailSent = e.email_sent === 1;
        const waSent = e.whatsapp_sent === 1;
        
        let statusHtml = emailSent || waSent ? 
            `<div style="display:flex;gap:4px">${emailSent ? '<span class="sent-badge">ğŸ“§âœ“</span>' : ''}${waSent ? '<span class="sent-badge">ğŸ’¬âœ“</span>' : ''}</div>` : 
            '<span style="color:#999">â€”</span>';
        
        const contact = e.email ? e.email : (e.phone ? e.phone : '<span style="color:#999">No contact</span>');
        const source = e.source ? `<span class="source-badge">${e.source}</span>` : '';
        
        return `
        <tr>
            <td><b>${e.name}</b><br><small style="color:#666">${e.city || ''}</small></td>
            <td>${e.type || "Unknown"}</td>
            <td style="font-size:11px;max-width:150px;overflow:hidden;text-overflow:ellipsis">${contact}</td>
            <td>${source}</td>
            <td>${statusHtml}</td>
            <td class="action-buttons">
                <button class="${emailSent ? 'btn btn-sent' : 'btn btn-email'}" style="padding:6px 10px;font-size:12px" 
                    onclick="openModal(${e.id})" ${!e.email ? 'disabled' : ''}>
                    ${emailSent ? 'âœ“' : 'ğŸ“§'}
                </button>
                <button class="${waSent ? 'btn btn-sent' : 'btn btn-success'}" style="padding:6px 10px;font-size:12px" 
                    onclick="quickWA(${e.id})" ${!e.phone ? 'disabled' : ''}>
                    ${waSent ? 'âœ“' : 'ğŸ’¬'}
                </button>
            </td>
        </tr>
    `}).join("");
}

// ============ MODALS & ACTIONS ============

function openModal(id) {
    current = entities.find(e => e.id === id);
    if (!current) return;
    
    document.getElementById("recipient").value = current.name;
    document.getElementById("recipientType").value = current.type || "Unknown";
    document.getElementById("recipientEmail").value = current.email || "No email";
    document.getElementById("recipientPhone").value = current.phone || current.whatsapp || "No phone";
    document.getElementById("msgText").textContent = PROPOSAL_TEMPLATE;
    document.getElementById("sendStatus").textContent = "";
    
    const warningEl = document.getElementById("alreadySentWarning");
    warningEl.style.display = (current.email_sent === 1 || current.whatsapp_sent === 1) ? "block" : "none";
    
    renderAttachments('modalAttachments', availableAttachments);
    
    const sendBtn = document.getElementById("sendEmailBtn");
    const sendWABtn = document.getElementById("sendWABtn");
    
    sendBtn.className = !emailConfigured || !current.email ? "btn btn-disabled" : current.email_sent === 1 ? "btn btn-sent" : "btn btn-email";
    sendBtn.innerHTML = current.email_sent === 1 ? "âœ“ Resend" : "ğŸ“§ Email";
    
    sendWABtn.className = !current.phone && !current.whatsapp ? "btn btn-disabled" : current.whatsapp_sent === 1 ? "btn btn-sent" : "btn btn-success";
    sendWABtn.innerHTML = current.whatsapp_sent === 1 ? "âœ“ Resend" : "ğŸ’¬ WhatsApp + ğŸ–¼ï¸";
    
    document.getElementById("modal").classList.add("active");
}

function closeModal() { document.getElementById("modal").classList.remove("active"); }

function showPermissionModal(instructions) {
    if (instructions?.length) {
        document.getElementById("permissionInstructions").innerHTML = instructions.map(i => `<li>${i}</li>`).join('');
    }
    document.getElementById("permissionModal").classList.add("active");
}

function closePermissionModal() { document.getElementById("permissionModal").classList.remove("active"); pendingWAEntity = null; }

async function confirmPermission() {
    try {
        await fetch(API + "/whatsapp/grant-permission", { method: "POST" });
        waPermissionGranted = true;
        toast("Permission confirmed!", "success");
        closePermissionModal();
        if (pendingWAEntity) { setTimeout(() => quickWA(pendingWAEntity), 500); pendingWAEntity = null; }
    } catch (e) { toast("Error", "error"); }
}

async function quickWA(id) {
    const entity = entities.find(e => e.id === id);
    if (!entity) return;
    
    const phone = entity.phone || entity.whatsapp;
    if (!phone) { toast("No phone number", "error"); return; }
    
    toast("Sending WhatsApp with image...", "info");
    
    try {
        const r = await fetch(API + "/whatsapp/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone, entity_id: entity.id, direct_send: true, include_image: true })
        });
        const d = await r.json();
        
        if (d.needs_permission) {
            pendingWAEntity = id;
            showPermissionModal(d.instructions);
            return;
        }
        
        if (d.success) {
            toast("âœ… WhatsApp sent" + (d.image ? " with image!" : "!"), "success");
            entity.whatsapp_sent = 1;
            render();
            refresh();
        } else {
            toast("Error: " + (d.error || "Unknown"), "error");
        }
    } catch (e) { toast("Error: " + e.message, "error"); }
}

async function sendWA() {
    if (!current) return;
    const phone = current.phone || current.whatsapp;
    if (!phone) { toast("No phone", "error"); return; }
    
    const includeImage = document.getElementById("includeWAImage").checked;
    const statusEl = document.getElementById("sendStatus");
    const sendBtn = document.getElementById("sendWABtn");
    
    statusEl.innerHTML = '<span class="loading"></span> Sending WhatsApp' + (includeImage ? ' with image...' : '...');
    sendBtn.disabled = true;
    
    try {
        const r = await fetch(API + "/whatsapp/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone, entity_id: current.id, direct_send: true, include_image: includeImage })
        });
        const d = await r.json();
        
        if (d.needs_permission) {
            statusEl.innerHTML = 'âš ï¸ Permission required';
            pendingWAEntity = current.id;
            showPermissionModal(d.instructions);
            sendBtn.disabled = false;
            return;
        }
        
        if (d.success) {
            statusEl.innerHTML = 'âœ… WhatsApp sent' + (d.image ? ' with image!' : '!');
            sendBtn.className = "btn btn-sent";
            sendBtn.innerHTML = "âœ“ Sent";
            current.whatsapp_sent = 1;
            refresh();
        } else {
            statusEl.innerHTML = 'âŒ ' + (d.error || "Error");
            sendBtn.disabled = false;
        }
    } catch (e) {
        statusEl.innerHTML = 'âŒ ' + e.message;
        sendBtn.disabled = false;
    }
}

async function sendEmail() {
    if (!current?.email) { toast("No email", "error"); return; }
    if (!emailConfigured) { toast("Email not configured", "error"); return; }
    
    const statusEl = document.getElementById("sendStatus");
    const sendBtn = document.getElementById("sendEmailBtn");
    const subject = document.getElementById("emailSubject").value;
    const includeAttachments = document.getElementById("includeAttachments").checked;
    
    statusEl.innerHTML = '<span class="loading"></span> Sending email...';
    sendBtn.disabled = true;
    
    try {
        const r = await fetch(API + "/email/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                to_email: current.email,
                subject,
                recipient_name: current.name,
                include_attachments: includeAttachments,
                entity_id: current.id
            })
        });
        const d = await r.json();
        
        if (r.ok && d.success) {
            statusEl.innerHTML = 'âœ… Email sent to ' + current.email;
            sendBtn.className = "btn btn-sent";
            sendBtn.innerHTML = "âœ“ Sent";
            current.email_sent = 1;
            refresh();
        } else {
            statusEl.innerHTML = 'âŒ ' + (d.detail || d.error || "Error");
            sendBtn.disabled = false;
        }
    } catch (e) {
        statusEl.innerHTML = 'âŒ ' + e.message;
        sendBtn.disabled = false;
    }
}

function exportCSV() { window.open(API + "/export/csv", "_blank"); }

function toast(msg, type) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.className = "toast show " + type;
    setTimeout(() => t.classList.remove("show"), 4000);
}
</script>
</body>
</html>
