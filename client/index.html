<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>Pickleball Trade</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1200px;margin:0 auto}
.header{text-align:center;color:white;margin-bottom:30px}
.card{background:white;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;margin-bottom:8px}
.form-group input,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px}
.btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.btn-success{background:#25D366;color:white}
.btn-email{background:linear-gradient(135deg,#4285f4,#34a853);color:white}
.btn-disabled{background:#ccc;cursor:not-allowed}
.btn-disabled:hover{transform:none;box-shadow:none}
/* Sent status buttons */
.btn-sent{background:linear-gradient(135deg,#28a745,#20c997);color:white;position:relative}
.btn-sent::after{content:'‚úì';position:absolute;top:-5px;right:-5px;background:#fff;color:#28a745;border-radius:50%;width:18px;height:18px;font-size:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
.stat{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;text-align:center}
.stat.success{background:linear-gradient(135deg,#28a745,#20c997)}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
.toast{position:fixed;bottom:20px;right:20px;padding:16px 24px;border-radius:8px;display:none;z-index:2000}
.toast.show{display:block}
.toast.success{background:#28a745;color:white}
.toast.error{background:#dc3545;color:white}
.toast.info{background:#17a2b8;color:white}
.toast.warning{background:#ffc107;color:#333}
.email-status{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-size:14px}
.email-status.configured{background:#d4edda;color:#155724}
.email-status.not-configured{background:#f8d7da;color:#721c24}
.send-status{font-size:12px;color:#666;margin-top:8px}
.loading{display:inline-block;width:16px;height:16px;border:2px solid #ccc;border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.attachment-list{background:#f8f9fa;border-radius:8px;padding:12px;margin-top:12px}
.attachment-item{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid #eee}
.attachment-item:last-child{border-bottom:none}
.attachment-icon{font-size:20px}
.attachment-name{flex:1;font-size:13px;word-break:break-all}
.attachment-size{font-size:11px;color:#666;white-space:nowrap}
.attachment-warning{color:#dc3545;font-size:11px}
.checkbox-group{display:flex;align-items:center;gap:8px;margin:12px 0}
.checkbox-group input[type="checkbox"]{width:18px;height:18px}
.sent-badge{display:inline-flex;align-items:center;gap:4px;background:#d4edda;color:#155724;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:8px}
.action-buttons{display:flex;gap:4px;align-items:center}
.permission-modal{background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:16px;margin:16px 0}
.permission-modal h4{color:#856404;margin-bottom:12px}
.permission-modal ol{margin-left:20px;color:#856404}
.permission-modal li{margin-bottom:8px}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üèì Pickleball Trade</h1>
<p>Outreach Dashboard</p>
<div id="emailStatus" class="email-status not-configured" style="margin-top:12px">
Checking email status...
</div>
</div>

<div class="card"><h2>üìß Email Configuration</h2>
<p style="margin-bottom:16px;color:#666">Configure Gmail credentials in the <code>.env</code> file on the server:</p>
<div class="grid">
<div class="form-group"><label>GMAIL_EMAIL</label><input type="text" id="gmailEmail" placeholder="Configured on server" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Status</label><input type="text" id="gmailStatus" placeholder="Checking..." readonly style="background:#f8f9fa"></div>
</div>

<h3 style="margin-top:20px;margin-bottom:12px">üìé Email Attachments</h3>
<div id="attachmentsList" class="attachment-list">
<p style="color:#666;text-align:center">Loading attachments...</p>
</div>

<button class="btn btn-primary" style="margin-top:16px" onclick="checkEmailStatus()">üîÑ Check Status</button>
</div>

<div class="card"><h2>üîç Discover Leads</h2>
<div class="grid">
<div class="form-group"><label>City</label><select id="city"><option value="">Select</option></select></div>
<div class="form-group"><label>Limit</label><input type="number" id="limit" value="5" style="width:100px"></div>
</div>
<button class="btn btn-primary" onclick="discover()">Discover</button>
</div>

<div class="stats">
<div class="stat"><h3 id="total">0</h3><p>Total Leads</p></div>
<div class="stat"><h3 id="high">0</h3><p>Types</p></div>
<div class="stat success"><h3 id="emails">0</h3><p>üìß Emails Sent</p></div>
<div class="stat success"><h3 id="whatsapps">0</h3><p>üí¨ WhatsApp Sent</p></div>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;margin-bottom:20px">
<h2>üìã Leads</h2>
<div>
<button class="btn btn-primary" onclick="refresh()">Refresh</button>
<button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
</div>
</div>
<table><thead><tr><th>Name</th><th>Type</th><th>Contact</th><th>City</th><th>Status</th><th>Actions</th></tr></thead>
<tbody id="tbody"><tr><td colspan="6" style="text-align:center">Loading...</td></tr></tbody>
</table>
</div>
</div>

<!-- Permission Request Modal -->
<div class="modal" id="permissionModal">
<div class="modal-content">
<h2>üîê Accessibility Permission Required</h2>
<div class="permission-modal">
<h4>One-time setup to enable WhatsApp automation:</h4>
<ol id="permissionInstructions">
<li>Open <b>System Settings</b> on your Mac</li>
<li>Go to <b>Privacy & Security ‚Üí Accessibility</b></li>
<li>Click the lock icon to make changes</li>
<li>Add and enable <b>Terminal</b> (or VS Code if running from IDE)</li>
<li>Click "Done" below after granting permission</li>
</ol>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-success" onclick="confirmPermission()">‚úÖ Done - Permission Granted</button>
<button class="btn" onclick="closePermissionModal()">Cancel</button>
</div>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-content">
<h2>üì§ Send Proposal</h2>
<div id="alreadySentWarning" style="display:none;background:#fff3cd;color:#856404;padding:12px;border-radius:8px;margin-bottom:16px">
‚ö†Ô∏è Message already sent to this lead. Send again?
</div>
<div class="form-group"><label>To</label><input id="recipient" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Email</label><input id="recipientEmail" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Phone</label><input id="recipientPhone" readonly style="background:#f8f9fa"></div>
<div class="form-group"><label>Subject</label><input id="emailSubject" value="Pickleball Partnership Opportunity - Manh Thang Factory"></div>

<div class="checkbox-group">
<input type="checkbox" id="includeAttachments" checked>
<label for="includeAttachments" style="margin:0;font-weight:normal">üìé Include email attachments (PDF brochure + Product image)</label>
</div>

<div id="modalAttachments" class="attachment-list" style="margin-bottom:16px">
</div>

<div class="form-group">
<label>Message Preview</label>
<div id="msgText" style="background:#f8f9fa;padding:16px;border-radius:8px;white-space:pre-wrap;max-height:200px;overflow-y:auto;font-size:13px"></div>
</div>
<div id="sendStatus" class="send-status"></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-email" id="sendEmailBtn" onclick="sendEmail()">üìß Send Email</button>
<button class="btn btn-success" id="sendWABtn" onclick="sendWA()">üí¨ WhatsApp Direct</button>
<button class="btn" onclick="closeModal()">Close</button>
</div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = "http://localhost:8000";
let entities = [], current = null, emailConfigured = false;
let availableAttachments = [];
let waPermissionGranted = false;
let pendingWAEntity = null;

const PROPOSAL_TEMPLATE = `Dear Sir / Madam,

Greetings.

We are pleased to introduce Manh Thang Industrial Service Development Company Limited (Vietnam), a specialized manufacturer and OEM producer of tournament-grade pickleball balls, and propose a potential collaboration for bulk supply and distribution in the Indian market.

Manh Thang Pickleball Factory operates with advanced rotational hot molding technology, strict quality management systems, and international compliance standards. The factory currently supplies to domestic and export markets including the USA and Europe.

‚úÖ Product Highlight ‚Äì E-WIN (ONE WIN) Pickleball Balls
‚Ä¢ Certified compliant with USA Pickleball Association (USAPA) standards
‚Ä¢ Designed for international competition and tournaments
‚Ä¢ Indoor ball weight: ~26 g / Outdoor ball weight: ~26.5 g
‚Ä¢ Diameter: 74 mm (¬±5%)
‚Ä¢ Hardness: 44‚Äì46 HD (balanced control & durability)
‚Ä¢ 40 precision-drilled holes

üè≠ Manufacturing Strength
‚Ä¢ 5 automatic rotational casting technology production lines
‚Ä¢ Current capacity: 25,000‚Äì30,000 balls per day
‚Ä¢ Factory area: over 7,000 m¬≤ | 65 skilled staff members

üì¶ Product Portfolio
‚Ä¢ S2 Tournament Pickleball
‚Ä¢ E-WIN (ONE WIN) Tournament Series
‚Ä¢ Vincent Series, Multi-color Pickleballs
‚Ä¢ 100% Biodegradable Pickleballs (eco-friendly option)

ü§ù Why Partner With Manh Thang
‚Ä¢ Consistent tournament-grade quality
‚Ä¢ Competitive factory-direct pricing
‚Ä¢ OEM / Private label manufacturing available
‚Ä¢ Reliable production capacity & delivery schedules

üìû Factory Contact (Vietnam ‚Äì Head Office)
Manh Thang Industrial Service Development Company Limited
Phone: +84 91 253 16 66
Email: manhthang2666@gmail.com
Website: www.manhthangpickleballfactory.com

For India coordination:
Vijay Pawar
Mobile / WhatsApp: +91-7975397211
Email: vijaykp.kp@gmail.com

Looking forward to your positive response!

Warm regards,
Vijay Pawar`;

document.addEventListener("DOMContentLoaded", () => {
    loadCities();
    refresh();
    checkEmailStatus();
    checkWAPermission();
});

function getFileIcon(filename) {
    if (filename.toLowerCase().endsWith('.pdf')) return 'üìÑ';
    if (filename.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/)) return 'üñºÔ∏è';
    return 'üìé';
}

function renderAttachments(containerId, attachments) {
    const container = document.getElementById(containerId);
    if (!attachments || attachments.length === 0) {
        container.innerHTML = '<p style="color:#666;text-align:center;font-size:13px">No attachments in uploads folder</p>';
        return;
    }
    
    container.innerHTML = attachments.map(a => `
        <div class="attachment-item">
            <span class="attachment-icon">${getFileIcon(a.name)}</span>
            <span class="attachment-name">${a.name}</span>
            <span class="attachment-size">${a.size_mb} MB</span>
            ${a.too_large ? '<span class="attachment-warning">‚ö†Ô∏è Too large for email (OK for WhatsApp)</span>' : '‚úÖ'}
        </div>
    `).join('');
}

async function checkEmailStatus() {
    const statusEl = document.getElementById("emailStatus");
    const gmailStatusEl = document.getElementById("gmailStatus");
    const gmailEmailEl = document.getElementById("gmailEmail");
    
    try {
        const r = await fetch(API + "/email/status");
        const d = await r.json();
        emailConfigured = d.configured;
        availableAttachments = d.attachments || [];
        
        if (d.configured) {
            statusEl.className = "email-status configured";
            statusEl.innerHTML = "‚úÖ Email configured: " + d.sender;
            gmailStatusEl.value = "‚úì Configured";
            gmailEmailEl.value = d.sender;
        } else {
            statusEl.className = "email-status not-configured";
            statusEl.innerHTML = "‚ö†Ô∏è Email not configured - Set GMAIL_EMAIL & GMAIL_APP_PASSWORD in .env";
            gmailStatusEl.value = "‚úó Not configured";
            gmailEmailEl.value = "Not set";
        }
        
        renderAttachments('attachmentsList', availableAttachments);
        
    } catch (e) {
        statusEl.className = "email-status not-configured";
        statusEl.innerHTML = "‚ùå Cannot connect to API";
        gmailStatusEl.value = "Error";
        gmailEmailEl.value = "API not reachable";
        document.getElementById('attachmentsList').innerHTML = '<p style="color:#dc3545">Cannot load attachments</p>';
    }
}

async function checkWAPermission() {
    try {
        const r = await fetch(API + "/whatsapp/status");
        const d = await r.json();
        waPermissionGranted = d.permission_granted;
    } catch (e) {
        waPermissionGranted = false;
    }
}

async function loadCities() {
    try {
        const r = await fetch(API + "/cities");
        const d = await r.json();
        const s = document.getElementById("city");
        d.cities.forEach(c => {
            const o = document.createElement("option");
            o.value = c.name;
            o.textContent = c.name;
            s.appendChild(o);
        });
    } catch (e) {
        console.error(e);
    }
}

async function discover() {
    const city = document.getElementById("city").value;
    const limit = document.getElementById("limit").value;
    if (!city) {
        toast("Select a city", "error");
        return;
    }
    try {
        toast("Discovering leads...", "info");
        const r = await fetch(API + "/discover", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ city, limit: parseInt(limit) })
        });
        const d = await r.json();
        toast("Found " + d.discovered + " leads!", "success");
        refresh();
    } catch (e) {
        toast("Error discovering leads", "error");
    }
}

async function refresh() {
    try {
        const r = await fetch(API + "/entities");
        const d = await r.json();
        entities = d.entities || [];
        render();
        
        const s = await (await fetch(API + "/stats")).json();
        document.getElementById("total").textContent = s.total_entities || 0;
        document.getElementById("high").textContent = Object.keys(s.by_type || {}).length;
        document.getElementById("emails").textContent = s.emails_sent || 0;
        document.getElementById("whatsapps").textContent = s.whatsapp_sent || 0;
    } catch (e) {
        document.getElementById("tbody").innerHTML = '<tr><td colspan="6">API not running</td></tr>';
    }
}

function render() {
    const t = document.getElementById("tbody");
    if (entities.length === 0) {
        t.innerHTML = '<tr><td colspan="6" style="text-align:center">No leads yet. Discover some!</td></tr>';
        return;
    }
    t.innerHTML = entities.map(e => {
        const emailSent = e.email_sent === 1;
        const waSent = e.whatsapp_sent === 1;
        
        // Status badges
        let statusHtml = '';
        if (emailSent || waSent) {
            statusHtml = '<div style="display:flex;gap:4px;flex-wrap:wrap">';
            if (emailSent) statusHtml += '<span class="sent-badge">üìß ‚úì</span>';
            if (waSent) statusHtml += '<span class="sent-badge">üí¨ ‚úì</span>';
            statusHtml += '</div>';
        } else {
            statusHtml = '<span style="color:#999">‚Äî</span>';
        }
        
        // Button classes based on sent status
        const emailBtnClass = emailSent ? 'btn btn-sent' : 'btn btn-email';
        const waBtnClass = waSent ? 'btn btn-sent' : 'btn btn-success';
        
        // Contact info
        const contact = e.email ? e.email : (e.phone ? e.phone : '<span style="color:#999">No contact</span>');
        
        return `
        <tr>
            <td><b>${e.name}</b></td>
            <td>${e.type || "Unknown"}</td>
            <td style="font-size:12px">${contact}</td>
            <td>${e.city || ""}</td>
            <td>${statusHtml}</td>
            <td class="action-buttons">
                <button class="${emailBtnClass}" style="padding:8px 12px;margin:2px" 
                    onclick="openModal(${e.id})" ${!e.email ? 'disabled title="No email"' : ''}>
                    ${emailSent ? '‚úì' : 'üìß'}
                </button>
                <button class="${waBtnClass}" style="padding:8px 12px;margin:2px" 
                    onclick="quickWA(${e.id})" ${!e.phone ? 'disabled title="No phone"' : ''}>
                    ${waSent ? '‚úì' : 'üí¨'}
                </button>
            </td>
        </tr>
    `}).join("");
}

function openModal(id) {
    current = entities.find(e => e.id === id);
    if (!current) return;
    
    document.getElementById("recipient").value = current.name;
    document.getElementById("recipientEmail").value = current.email || "No email available";
    document.getElementById("recipientPhone").value = current.phone || "No phone available";
    document.getElementById("msgText").textContent = PROPOSAL_TEMPLATE.replace("Dear Sir / Madam", "Dear " + (current.name || "Sir / Madam"));
    document.getElementById("sendStatus").textContent = "";
    document.getElementById("includeAttachments").checked = true;
    
    // Show warning if already sent
    const warningEl = document.getElementById("alreadySentWarning");
    if (current.email_sent === 1 || current.whatsapp_sent === 1) {
        warningEl.style.display = "block";
    } else {
        warningEl.style.display = "none";
    }
    
    // Render attachments in modal
    renderAttachments('modalAttachments', availableAttachments.filter(a => !a.too_large));
    
    const sendBtn = document.getElementById("sendEmailBtn");
    const sendWABtn = document.getElementById("sendWABtn");
    
    // Update email button
    if (!emailConfigured) {
        sendBtn.className = "btn btn-disabled";
        sendBtn.title = "Configure email in .env file";
        sendBtn.innerHTML = "üìß Send Email";
    } else if (!current.email) {
        sendBtn.className = "btn btn-disabled";
        sendBtn.title = "No email address";
        sendBtn.innerHTML = "üìß Send Email";
    } else if (current.email_sent === 1) {
        sendBtn.className = "btn btn-sent";
        sendBtn.title = "Already sent - click to resend";
        sendBtn.innerHTML = "‚úì Resend Email";
    } else {
        sendBtn.className = "btn btn-email";
        sendBtn.title = "";
        sendBtn.innerHTML = "üìß Send Email";
    }
    
    // Update WhatsApp button
    if (!current.phone) {
        sendWABtn.className = "btn btn-disabled";
        sendWABtn.innerHTML = "üí¨ WhatsApp";
    } else if (current.whatsapp_sent === 1) {
        sendWABtn.className = "btn btn-sent";
        sendWABtn.innerHTML = "‚úì Resend WA";
    } else {
        sendWABtn.className = "btn btn-success";
        sendWABtn.innerHTML = "üí¨ WhatsApp Direct";
    }
    
    document.getElementById("modal").classList.add("active");
}

function closeModal() {
    document.getElementById("modal").classList.remove("active");
}

function showPermissionModal(instructions) {
    if (instructions && instructions.length > 0) {
        const list = document.getElementById("permissionInstructions");
        list.innerHTML = instructions.map(i => `<li>${i}</li>`).join('');
    }
    document.getElementById("permissionModal").classList.add("active");
}

function closePermissionModal() {
    document.getElementById("permissionModal").classList.remove("active");
    pendingWAEntity = null;
}

async function confirmPermission() {
    try {
        await fetch(API + "/whatsapp/grant-permission", { method: "POST" });
        waPermissionGranted = true;
        toast("Permission confirmed! Retrying...", "success");
        closePermissionModal();
        
        // Retry the pending WhatsApp send
        if (pendingWAEntity) {
            setTimeout(() => quickWA(pendingWAEntity), 500);
            pendingWAEntity = null;
        }
    } catch (e) {
        toast("Error confirming permission", "error");
    }
}

// Quick WhatsApp from table button - DIRECT SEND
async function quickWA(id) {
    const entity = entities.find(e => e.id === id);
    if (!entity || !entity.phone) {
        toast("No phone number available", "error");
        return;
    }
    
    toast("Opening WhatsApp & sending...", "info");
    
    try {
        const r = await fetch(API + "/whatsapp/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                phone: entity.phone,
                entity_id: entity.id,
                direct_send: true
            })
        });
        
        const d = await r.json();
        
        if (d.needs_permission) {
            // Show permission instructions
            pendingWAEntity = id;
            showPermissionModal(d.instructions);
            return;
        }
        
        if (d.success) {
            toast("‚úÖ WhatsApp message sent to " + entity.name, "success");
            // Update local entity
            entity.whatsapp_sent = 1;
            render();
            refresh();
        } else {
            toast("Error: " + (d.error || "Unknown error"), "error");
        }
    } catch (e) {
        toast("Error sending WhatsApp: " + e.message, "error");
    }
}

// Send WhatsApp from modal
async function sendWA() {
    if (!current || !current.phone) {
        toast("No phone number", "error");
        return;
    }
    
    const statusEl = document.getElementById("sendStatus");
    const sendBtn = document.getElementById("sendWABtn");
    
    statusEl.innerHTML = '<span class="loading"></span> Opening WhatsApp & sending message...';
    sendBtn.disabled = true;
    
    try {
        const r = await fetch(API + "/whatsapp/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                phone: current.phone,
                entity_id: current.id,
                direct_send: true
            })
        });
        
        const d = await r.json();
        
        if (d.needs_permission) {
            statusEl.innerHTML = '‚ö†Ô∏è Accessibility permission required - see popup';
            pendingWAEntity = current.id;
            showPermissionModal(d.instructions);
            sendBtn.disabled = false;
            return;
        }
        
        if (d.success) {
            statusEl.innerHTML = '‚úÖ WhatsApp message sent!';
            toast("WhatsApp message sent!", "success");
            sendBtn.className = "btn btn-sent";
            sendBtn.innerHTML = "‚úì Sent";
            current.whatsapp_sent = 1;
            refresh();
        } else {
            statusEl.innerHTML = '‚ùå Error: ' + (d.error || "Unknown");
            sendBtn.disabled = false;
        }
    } catch (e) {
        statusEl.innerHTML = '‚ùå Error: ' + e.message;
        sendBtn.disabled = false;
    }
}

async function sendEmail() {
    if (!current || !current.email) {
        toast("No email address", "error");
        return;
    }
    
    if (!emailConfigured) {
        toast("Email not configured! Set GMAIL_EMAIL & GMAIL_APP_PASSWORD in .env", "error");
        return;
    }
    
    const statusEl = document.getElementById("sendStatus");
    const sendBtn = document.getElementById("sendEmailBtn");
    const subject = document.getElementById("emailSubject").value;
    const includeAttachments = document.getElementById("includeAttachments").checked;
    
    statusEl.innerHTML = '<span class="loading"></span> Sending email' + (includeAttachments ? ' with attachments...' : '...');
    sendBtn.disabled = true;
    
    try {
        const r = await fetch(API + "/email/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                to_email: current.email,
                subject: subject,
                recipient_name: current.name,
                include_attachments: includeAttachments,
                entity_id: current.id
            })
        });
        
        const d = await r.json();
        
        if (r.ok && d.success) {
            let msg = '‚úÖ Email sent to ' + current.email;
            if (d.attachments && d.attachments.length > 0) {
                msg += ' with ' + d.attachments.length + ' attachment(s)';
            }
            statusEl.innerHTML = msg;
            
            sendBtn.className = "btn btn-sent";
            sendBtn.innerHTML = "‚úì Sent";
            toast("Email sent successfully!", "success");
            current.email_sent = 1;
            refresh();
        } else {
            statusEl.innerHTML = '‚ùå Error: ' + (d.detail || d.error || "Unknown error");
            sendBtn.disabled = false;
        }
    } catch (e) {
        statusEl.innerHTML = '‚ùå Error: ' + e.message;
        sendBtn.disabled = false;
    }
}

function exportCSV() {
    window.open(API + "/export/csv", "_blank");
}

function toast(msg, type) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.className = "toast show " + type;
    setTimeout(() => t.classList.remove("show"), 4000);
}
</script>
</body>
</html>
